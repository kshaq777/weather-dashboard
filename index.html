<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav id="navbar" class="navbar navbar-dark">
        <span class="navbar-brand mb-0 h1">Weather Dashboard</span>
    </nav>
    <div id="banner" class="container">
        <h1>Rutgers Bootcamp Weather Service</h1>
    </div>
    <div id="main" class="container">
        <div class="row">
            <div class="col-12 col-sm-3">
                <input id="city" placeholder="Enter City">
                <button id="getWeather">Get Weather</button>
            </div>
            <div class="col-12 col-sm-9">
                <div id="today" class="row">
                    <div class="card">
                        <div id="today-card" class="card-body">
                          Search to see the magic.
                        </div>
                      </div>
                </div>
                <div id="forecast" class="row">
                    
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/places.js@1.19.0">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/places.js@1.19.0/dist/cdn/placesAutocompleteDataset.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous"></script>
    <script>
        // Initialize variables for later usage
        var cityLat;
        var cityLng;
        var searches = localStorage.getItem("cities");
        var city= '';
        var latLng = {};

        $('#getWeather').on('click', function(e) {
            e.preventDefault();
            
            // If the array isn't there, create it
            if (!searches) {
                searches = [];
            } else {
                searches = JSON.parse(searches);
            }

            // Store the search in local storage
            city = $('#city').val();
            latLng = {lat: cityLat, lng: cityLng};
            searches.push({ city: city, latLng: latLng});
            localStorage.setItem("searches", JSON.stringify(searches));

            // Make the ajax call to get the weather data
            $.ajax({
                url: 'https://api.openweathermap.org/data/2.5/onecall?lat='+cityLat+'&lon='+cityLng+'&appid=c406a5e75ec8149f72f933aa5f754ef9&units=imperial',
                method: 'GET'
            }).then(function(response) {
                console.log(response);

                // Start parsing the data and filling the HTML for today
                var today = response.current;
                var todayEl = $('#today-card');
                todayEl.empty();

                var todayTitle = $('<h2>').text(city);
                var todayDate = $('<h4>').text(moment().format("dddd, MMMM Do YYYY"));
                var currentTemp = $('<p>').text('Current Temperature: '+today.temp);
                var currentWeather = $('<p>').text("What it's like out: " +today.weather[0].description);
                var currentIcon = $('<img>').attr('src', "http://openweathermap.org/img/wn/" + today.weather[0].icon + ".png");
                var currentUVI = $('<p>').text('UVI: '+today.uvi);
                var currentHum = $('<p>').text('Humidity: '+today.humidity);
                todayEl.append(todayTitle, '<br>', todayDate, '<br>', currentTemp, '<br>', currentIcon, currentWeather, '<br>', currentUVI, '<br>', currentHum);


            })

        })
        
    </script>
    <script>
        // Use Algolia to auto-fill search options for cities, derive lat/long to use onecall API transaction
        (function() {
        var placesAutocomplete = places({
            appId: 'plKZWQZ4OYQ8',
            apiKey: '383d469cca9fb46e33f4d34df46cd049',
            container: document.querySelector('#city'),
            templates: {
                value: function(suggestion) {
                return suggestion.name;
            }}
        }).configure({
            type: 'city',
            aroundLatLngViaIP: false,
        });
        placesAutocomplete.on("change", function resultSelected(e) {
            cityLat = parseFloat(e.suggestion.latlng.lat);
            cityLng = parseFloat(e.suggestion.latlng.lng);
            console.log(cityLat+','+cityLng);
            });
        })();
    </script>
</body>
</html>